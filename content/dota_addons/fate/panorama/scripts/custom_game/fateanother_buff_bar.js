var buffHasStacks = {
    modifier_kanshou_byakuya: true,
    modifier_rho_aias: true,
    modifier_UBW_chant: true,
    modifier_atalanta_calydonian_hunt: true,
    modifier_priestess_arrow_count: true,
    modifier_atalanta_last_spurt: true,
    modifier_arrows_of_big_dipper: true,
    modifier_atalanta_calydonian_snipe_window: true,
    modifier_dark_passage: true,
    modifier_verg_damage_tracker: true,
    modifier_4_days_loop: true,
    modifier_lancer_rune_of_combat: true,
    modifier_gae_buidhe: true,
    modifier_gae_dearg: true,
    modifier_gawain_saint_bonus: true,
    modifier_light_of_galatine_burn: true,
    modifier_gilgamesh_rain_of_swords: true,
    modifier_courage_enemy_debuff_stack: true,
    modifier_courage_self_buff_stack: true,
    modifier_reincarnation_stack: true,
    modifier_god_hand_stock: true,
    modifier_jtr_curse: true,
    modifier_jtr_curse_slow:true,
    modifier_jtr_holy_mother_passive: true,
    modifier_magic_resistance_ex_shield: true,
    modifier_agni_burn: true,
    modifier_overedge_stack: true,
    modifier_smg_overheat_stack: true,
    modifier_mark_of_fatality: true,
    modifier_furious_chain_buff: true,
    modifier_lishuwen_cosmic_orbit_attack: true,
    modifier_mordred_rampage_stack: true,
    modifier_gladiusanus_blauserum: true,
    modifier_gladiusanus: true,
    modifier_tennen_bonus: true,
    modifier_weak_constitution_progress: true,
    modifier_vortigern_ferocity_show: true,
    modifier_vortigern_ferocity_progress: true,
    modifier_derange_counter: true,
    modifier_immortal_passive: true,
    modifier_dirk_daggers_show: true,
    modifier_dirk_poison: true,
    modifier_dirk_weakening_venom: true,
    modifier_wind_protection_bonus: true,
    modifier_fiery_heaven_indicator: true,
    modifier_tamamo_fire_debuff: true,
    modifier_frigid_heaven_indicator: true,
    modifier_tamamo_ice_debuff: true,
    modifier_gust_heaven_indicator: true,
    modifier_tamamo_wind_debuff: true,
    modifier_soulstream_buff: true,
    modifier_mantra_ally: true,
    modifier_mantra_enemy: true,
    modifier_vlad_rebellious_intent: true,
    modifier_vlad_bleed: true,
    modifier_transfusion_blood_power: true,
    modifier_fran_lightning_slow: true,
    modifier_fran_electric_count: true,
    modifier_lubu_rebel_buff: true,
    modifier_lubu_ruthless_counter: true,
    modifier_right_hand: true,
    modifier_black_key_count: true,
    modifier_amakusa_baptism: true,
    modifier_amakusa_god_buff: true,
    modifier_edmond_hate: true,
    modifier_edmond_merciless: true,
    modifier_zhuge_thunder_storm_slow: true,
    modifier_kinghassan_stack: true,

    modifier_lancer_incinerate: true,  
    modifier_courage_damage_stack_indicator: true,
    modifier_courage_stackable_buff: true,  
    modifier_ta_agi_bonus: true,   
    modifier_madness_stack: true,   
    modifier_soulstream_stack: true,   
    modifier_plains_of_water_int_debuff: true,
    modifier_plains_of_water_int_buff: true,
    modifier_priestess_of_the_hunt: true,
    modifier_calydonian_hunt: true,
    modifier_last_spurt: true,
    modifier_arrows_of_the_big_dipper: true,
	modifier_bleed: true,    
    modifier_vortigern_ferocity: true,
    modifier_ubw_chant_count: true,
    modifier_overedge_charge: true,
    modifier_cosmic_orbit: true,
    modifier_pc_bonus_damage: true,
    modifier_furious_chain_regen: true,   
    modifier_weakening_venom: true,   
    modifier_holy_mother_buff: true,
    modifier_rain_of_swords_count: true,
    modifier_dirk_dagger_count: true,  
    modifier_crane_wing_stack: true,
    
};

var buffCooldown = {
    modifier_instinct_cooldown: 35,
    modifier_strike_air_cooldown: 60,
    modifier_max_excalibur_cooldown: 150,
    modifier_arrow_rain_cooldown: 180,
    modifier_hrunting_cooldown: 40,
    modifier_retreat_root_cooldown: 5,    
    modifier_cu_battle_continuation_cooldown: 60,
    modifier_wesen_gae_bolg_cooldown: 180,
    modifier_lancer_protection_from_arrows_cooldown: 40,
    modifier_max_mana_burst_cooldown: 150,
    modifier_hippogriff_ride_cooldown: 150,
    modifier_mordred_mmb_cooldown: 180,
    modifier_mordred_bc_cooldown: 60,
    modifier_gate_of_sky_cooldown: 200,
    modifier_combo_double_gae_bolg_cooldown: 200,
    modifier_pinning_god_cooldown: 90,
    modifier_scathach_rune_of_protection_cooldown: 60,
    modifier_fake_ubw_cooldown: 100,
    modifier_golden_wild_hunt_cooldown: 240,
    modifier_zekken_cooldown: 120,
    modifier_okita_mind_eye_cooldown: 20,
    modifier_lancelot_arondite_overload_cooldown: 180,
    modifier_eternal_arms_mastership_cooldown: 45,
    modifier_blessing_of_fairy_cooldown: 45,
    modifier_nuke_cooldown: 150,
    modifier_max_enuma_elish_cooldown: 160,
    modifier_gilgamesh_final_hour_cooldown:160,
    modifier_jtr_whitechapel_cooldown: 120,
    modifier_jtr_mental_pollution_cooldown: 60,
    modifier_tamamo_combo_cooldown: 105,
    modifier_mystic_shackle_cooldown: 30,
    modifier_polygamist_fist_cooldown: 60,
    modifier_combo_vasavi_cooldown: 200,
    modifier_lord_of_execution_cooldown: 180,
    modifier_protection_of_faith_cooldown: 60,
    modifier_laus_saint_claudius_cooldown: 120,
    modifier_invictus_spiritus_cooldown: 60,
    modifier_hecatic_graea_powered_cooldown: 150,
    modifier_casa_cooldown: 60,
    modifier_bellerophon_2_cooldown: 100,
    modifier_madmans_roar_cooldown: 150,
    modifier_tsubame_mai_cooldown: 180,
    modifier_sasaki_quickdraw_cooldown: 72,
    modifier_story_for_someones_sake_cooldown: 450,
    modifier_la_pucelle_cooldown: 135,
    modifier_4_days_loop_cooldown: 180,
    modifier_murderous_instinct_bash_cooldown: 1,
    modifier_rampant_warrior_cooldown: 100,
    modifier_minds_eye_cooldown: 20,
    modifier_annihilate_cooldown: 140,
    modifier_larret_de_mort_cooldown: 150,
    modifier_combo_galatine_cooldown: 180,
    modifier_gawain_blessing_cooldown: 60,
    modifier_raging_dragon_strike_cooldown: 110,
    modifier_atalanta_phoebus_snipe_cooldown: 450,
    modifier_atalanta_golden_apple_cooldown: 450,
    modifier_atalanta_calydonian_hunt_root_cooldown: 7,
    modifier_delusional_illusion_cooldown: 150,
    modifier_a_scroll_sated: 30,
    modifier_blasted_tree_cooldown: 240,
    modifier_lubu_immortal_cooldown: 100,
    modifier_lubu_combo_cooldown: 180,
    modifier_bathory_battle_continuation_cooldown: 100,
    modifier_bathory_innocent_cooldown: 180,
    modifier_bathory_combo_cooldown: 100,
    modifier_amakusa_twin_cooldown: 180,
    modifier_amakusa_baptism_cooldown: 100,
    modifier_amakusa_identity_cooldown: 180,
    modifier_edmond_esperer_cooldown: 100,
    modifier_edmond_chateau_cooldown: 180,
    modifier_zhuge_thunder_storm_cooldown: 180,
    modifier_kinghassan_combo_cooldown: 180,
    modifier_kinghassan_revive_cooldown: 180,
    modifier_kinghassan_faith_cooldown: 180,
    modifier_beheader_cooldown: 180,
    modifier_kinghassan_flame_cooldown: 180,
    modifier_hans_territory_cooldown: 180,
    modifier_hans_naked_king_cooldown: 180,
    modifier_hans_combo_cooldown: 180,
    modifier_faceless_king_cooldown: 180,
    modifier_robin_combo_cooldown: 180,
    modifier_dual_class_cooldown: 180,
    modifier_tiatum_umu_cooldown: 180,
    modifier_nobu_combo_cd: 170,
};

var buffProgress = {
    modifier_priestess_of_the_hunt: "modifier_priestess_of_the_hunt_progress",
    modifier_god_hand_stock: "modifier_reincarnation_progress",
    modifier_madness_stack: "modifier_madness_progress",
    modifier_magic_resistance_ex_shield: "modifier_magic_resistance_ex_progress",
    modifier_dirk_daggers_show: "modifier_dirk_daggers_progress",
    modifier_verg_damage_tracker: "modifier_verg_damage_tracker_progress",
    modifier_rune_of_ferocity: "modifier_rune_of_ferocity_progress",
    modifier_kavacha_kundala: "modifier_kavacha_kundala_progress",
    modifier_priestess_arrow_count: "modifier_priestess_arrow_progress",
    modifier_fran_electric_count: "modifier_fran_electric_progress",
};

var buffCanBeRemoved = {
    modifier_rho_aias: true,
    modifier_semiramis_mass_recall: true,
    //modifier_nameless_forest_ally: true,
};

function AltClickBuffs() {
    var that = this;

    var buffPanels = $.GetContextPanel().GetParent().GetParent().GetParent().FindChildTraverse('buffs').Children();
    var debuffPanels = $.GetContextPanel().GetParent().GetParent().GetParent().FindChildTraverse('debuffs').Children();
    this.buffPanels = buffPanels;
    this.debuffPanels = debuffPanels;

    this.BindOnActivate(buffPanels, false);
    this.BindOnActivate(debuffPanels, true);

    GameEvents.Subscribe("dota_player_update_selected_unit", function() {
        that.OnUpdate(true);
    });



}

AltClickBuffs.prototype.BindOnActivate = function(panels, isDebuff) {
    var that = this;

    $.Each(panels, function(panel, index) {
        panel.GetChild(0).SetPanelEvent(
            "onactivate",
            function() {
                that.OnActivate(index, isDebuff);
            }
        );
        panel.GetChild(0).SetPanelEvent(
            "oncontextmenu",
            function(){
                that.OnRightClick(index, isDebuff);
            }
        );
    });
}

AltClickBuffs.prototype.GetVisibleBuffs = function(unit, isDebuff) {
    var visibleBuffs = [];
    var nBuffs = Entities.GetNumBuffs(unit)
    for (var i = 0; i < nBuffs; i++)  {
        var buff = Entities.GetBuff(unit, i)
        if (Buffs.IsDebuff(unit, buff) !== isDebuff
            || Buffs.IsHidden(unit, buff)
            || !Buffs.GetName(unit, buff)) {
            continue;
        }
        visibleBuffs.push(buff);
    }
    return visibleBuffs;
}

AltClickBuffs.prototype.OnRightClick = function(index, isDebuff){
    var unit = Players.GetLocalPlayerPortraitUnit();
    var buff = this.GetVisibleBuffs(unit, isDebuff)[index];
    var buffName = Buffs.GetName(unit, buff);

    if(!buff){
        return;
    }

    var name = Buffs.GetName(unit, buff);
    for (var key in buffCanBeRemoved){
        if (name === key && buffCanBeRemoved[key] === true){
            GameEvents.SendCustomGameEventToServer("player_remove_buff",{iUnit: unit, sModifier: buffName});
            return;
        }

    }
}

AltClickBuffs.prototype.OnActivate = function(index, isDebuff) {
    var unit = Players.GetLocalPlayerPortraitUnit();

    if (!Entities.IsHero(unit) || !GameUI.IsAltDown()) {
        return;
    }

    var visibleBuffs = this.GetVisibleBuffs(unit, isDebuff);
    var buff = visibleBuffs[index];
    if (!buff) {
        return;
    }

    var name = Buffs.GetName(unit, buff);
    var duration = Buffs.GetDuration(unit, buff);
    var remainingTime = Buffs.GetRemainingTime(unit, buff);
    var stackCount = Buffs.GetStackCount(unit, buff);
    var hasStacks = !!buffHasStacks[name];

    var localName = $.Localize("#DOTA_Tooltip_" + name);

    var colour = isDebuff ? "_red_" : "_green_";

    var localPlayerId = Game.GetLocalPlayerID();
    var sameTeam = Entities.GetTeamNumber(unit) == Players.GetTeam(localPlayerId);

    if (sameTeam && unit != Players.GetPlayerHeroEntityIndex(localPlayerId)) {
        return;
    }

    var message = sameTeam ? "" : "Enemy _gold_" + Entities.GetUnitName(unit) + " ";

    message += "_gray__arrow_ ";

    if (buffCooldown[name]) {
        message += colour + localName + "_default_";
        if (sameTeam) {
            var remainingTime = Math.ceil(remainingTime);
            message += " ( _gold_" + remainingTime + "_default_ second" + (remainingTime == 1 ? "" : "s") + " remain )";
        }
    } else {
        message += "_default_Affected by " + colour + localName + "_default_";
        if (hasStacks) {
            message += " ( _gold_" + stackCount + "_default_ stack" + (stackCount == 1 ? "" : "s") + " )"
        }
    }

    GameEvents.SendCustomGameEventToServer("player_alt_click", {
        message: message,
        ability: this.name,
        unit: unit
    });
}

AltClickBuffs.prototype.OnUpdate = function(dontSchedule) {
    var that = this;
    var unit = Players.GetLocalPlayerPortraitUnit();

    var visibleBuffs = this.GetVisibleBuffs(unit, false);
    var panels = this.buffPanels;

    for (var i = 0; i < panels.length; i++) {
        var circlePanel = panels[i].FindChildTraverse("CircularDuration");
        var clip;
        if (visibleBuffs[i]) {
            var buff = visibleBuffs[i];
            var name = Buffs.GetName(unit, buff);
            if (buffProgress[name]) {
                var progressBuff = this.FindModifier(unit, buffProgress[name]);
                if (progressBuff) {
                    var stackCount = Buffs.GetStackCount(unit, progressBuff);
                    var progress = stackCount / 100 * 360;
                    if (progress > 360) {
                        progress = 360;
                    }
                    
                    clip = "radial(50% 50%, 0deg, " + progress + "deg)";
                    circlePanel.style.clip = clip;
                    circlePanel.hasClip = true;
                }
            }
        }
        if (!clip && circlePanel.hasClip) {
            circlePanel.style.clip = null;
            circlePanel.hasClip = false;
        }
    }

    if (!dontSchedule) {
        $.Schedule(0.05, function() {
            that.OnUpdate();
        });
    }
}

AltClickBuffs.prototype.FindModifier = function(unit, modifierName) {
    var nBuffs = Entities.GetNumBuffs(unit)
    for (var i = 0; i < nBuffs; i++) {
        var buff = Entities.GetBuff(unit, i)
        if (Buffs.GetName(unit, buff) == modifierName) {
            return buff;
        }
    };
    return null;
}

var altClickBuffs = new AltClickBuffs();

altClickBuffs.OnUpdate();


/*
function ChatModifier() {
    this.chatPanel = $.GetContextPanel().GetParent().GetParent().GetParent().FindChildTraverse('ChatLinesPanel');
    this.lastLine = null;
}

ChatModifier.prototype.UpdateChat = function() {
    var that = this;
    $.Schedule(0.1, function() {
        that.UpdateChat();
    });
    if (this.lastLine !== null && this.chatPanel.GetChildCount() === this.chatPanel.GetChildIndex(this.lastLine)) {
        return;
    }
    var nextLine;
    if (this.lastLine === null || this.chatPanel.GetChildIndex(this.lastLine) === null) {
        nextLine = this.chatPanel.GetChild(0);
    } else {
       nextLine = this.chatPanel.GetChild(this.chatPanel.GetChildIndex(this.lastLine) + 1);
    }
    while (nextLine !== null) {
        this.lastLine = nextLine;
        this.ModifyLine(this.lastLine);
        nextLine = this.chatPanel.GetChild(this.chatPanel.GetChildIndex(this.lastLine) + 1);
    }
}

ChatModifier.prototype.ModifyLine = function(line) {
    var text = line.text;
    $.Msg(line.Children());
}

var chat = new ChatModifier();
chat.UpdateChat();
*/
